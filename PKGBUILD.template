# Maintainer: Hauke Rehfeld <aur@haukerehfeld.de>
pkgname="${_pkgbase}-${_model}"

pkgver() {
    # track whisper.cpp release tags
    latest_release=$(git ls-remote -t "$_baseurl" | cut -f 2 | sed 's#^refs/tags/v\?##' | sort -r | head -n1 | cut -d '/' -f 3 )
    latest_commit="$(git ls-remote "$_baseurl" master | head -n1 | cut -f 1 | cut -b -12)"
    echo "$latest_release.r$latest_commit"
}


pkgver=2
pkgrel=2
pkgdesc="This is an autogenerated file, please see https://github.com/hrehfeld/archlinux-whisper.cpp-model"
arch=("i686" "x86_64")
url="${_baseurl}/tree/master/models"
license=("MIT")

makedepends=()
depends=()
conflicts=()
provides=()

_model_file="ggml-${_model}.bin"
_model_path="/usr/share/$pkgname/${_model_file}"

_versioned_download_script_basename="${_download_script_basename%.*}-$(pkgver).${_download_script_basename##*.}"

source=("$_versioned_download_script_basename::$_download_script_url")
sha256sums=("SKIP")

prepare() {
    chmod +x $_versioned_download_script_basename
    ./$_versioned_download_script_basename "$_model" "."
}


package() {
  install -Dm644 "${srcdir}/${_model_file}" "$pkgdir$_model_path"

  wrapper="whisper.cpp-${_model}"
  echo "#!/bin/sh
/usr/bin/whisper.cpp --model ${_model_path} "\"'$@'\" > "$srcdir/$wrapper"
  install -Dm755 "${srcdir}/$wrapper" "$pkgdir/usr/bin/$wrapper"


}
